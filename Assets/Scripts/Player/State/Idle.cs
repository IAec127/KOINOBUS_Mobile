using Cinemachine;
using System.Collections;
using System.Collections.Generic;
using TMPro;
using Unity.VisualScripting;
//using UnityEditor.Animations;
//using UnityEditor.Rendering;
//using UnityEditor.XR;
using UnityEngine;
using UnityEngine.Windows;

public class Idle : IState
{
	private CinemachineVirtualCamera vCamera = null;
	private CinemachineComposer vCameraCompoer;
	private Coroutine rollControlCoroutine = null;
	private bool beforeBrakeFlag = false;
	private float boostTime = 0.0f;
	private float boostCooldown = 0.0f;

	public Idle(PlayerMove playerMove) : base(playerMove) 
	{
		vCamera = GameObject.FindGameObjectWithTag("VirtualCamera").GetComponent<CinemachineVirtualCamera>();
		vCameraCompoer = vCamera.GetCinemachineComponent<CinemachineComposer>();
		state = PLAYER_STATE.IDLE;
	}
	public override void Enter()
	{
	}

	public override void Exit()
	{
	}

	public override void Update()
	{
		// ÔøΩNÔøΩÔøΩÔøΩbÔøΩ`(ÔøΩÔøΩÔøΩÔøΩ)
		if (player.IsAccel || player.EventType == EventManager.EVENT_TYPE.TAIL_WIND)
		{
			vCamera.m_Lens.FieldOfView += player.CameraData.AddFov;
			if (vCamera.m_Lens.FieldOfView > player.CameraData.MaxFov)
			{
				vCamera.m_Lens.FieldOfView = player.CameraData.MaxFov;
			}
		}
		// FOVÔøΩÔøΩÔøΩÔøΩÔøΩ∆Ç…ñﬂÇÔøΩ
		else if (vCamera.m_Lens.FieldOfView > player.CameraData.MinFov && player.EventType != EventManager.EVENT_TYPE.TAIL_WIND)
		{
			vCamera.m_Lens.FieldOfView += -player.CameraData.SubFov;
			if (vCamera.m_Lens.FieldOfView <= player.CameraData.MinFov)
			{
				vCamera.m_Lens.FieldOfView = player.CameraData.MinFov;
			}
		}

		if (!player.IsBoost && player.IsAccel && player.EventType != EventManager.EVENT_TYPE.TAIL_WIND)
		{
			//player.photonView.RPC(nameof(player.Effect.StartBoost), Photon.Pun.RpcTarget.All);
		}
		if (player.IsBoost && !player.IsAccel && player.EventType != EventManager.EVENT_TYPE.TAIL_WIND)
		{
			//player.photonView.RPC(nameof(player.Effect.EndBoost), Photon.Pun.RpcTarget.All);
		}
		player.IsAccel = false;

		if(player.IsBrake)
		{
			if (!beforeBrakeFlag)
			{
				//player.photonView.RPC(nameof(player.Effect.StartBrake), Photon.Pun.RpcTarget.All);
			}
		}
		else if (!player.IsBrake && beforeBrakeFlag)
		{
			//player.photonView.RPC(nameof(player.Effect.EndBrake), Photon.Pun.RpcTarget.All);
		}
		beforeBrakeFlag = player.IsBrake;
		player.IsBrake = false;

		// ÔøΩ≈íÔøΩEÔøΩ≈çÔøΩÔøΩÔøΩÔøΩxÔøΩ`ÔøΩFÔøΩbÔøΩN
		if (player.Speed < player.Data.MinSpeed)
		{
			player.Speed = player.Data.MinSpeed;
		}
		if (player.Speed > player.MaxSpeed)
		{
			player.Speed = player.MaxSpeed;
		}

		player.BulletSpawner.BulletUpdate();

		player.IsShot = false;
		player.IsCharging = false;
	}


	public override void FixedUpdate()
	{
		var vec = (player.transform.forward * player.Speed) - rigidbody.linearVelocity;
		// ÔøΩ«Ç…í«è]ÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÔøΩÔøΩ‘Ç≈Ç»ÇÔøΩÔøΩ»ÇÔøΩ
		if(!player.IsFollowWall)
		{
			// ÔøΩCÔøΩÔøΩÔøΩCÔøΩxÔøΩÔøΩÔøΩgÔøΩÔøΩÔøΩ»ÇÔøΩCÔøΩÔøΩÔøΩ…âÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÕÇÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ
			vec += player.burstVec;
		}

		// ÔøΩÕÇÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ
		rigidbody.AddForce(vec, ForceMode.Force);

		if(!player.IsAccel)
		{
			player.Speed -= player.Data.SpeedDecay * Time.fixedDeltaTime;
		}

		// Debug.Log(rigidbody.velocity.magnitude);
		
		// ÔøΩÔøΩÔøΩEÔøΩlÔøΩ`ÔøΩFÔøΩbÔøΩN
		if (rigidbody.linearVelocity.magnitude > player.MaxSpeed)
		{
			rigidbody.linearVelocity = rigidbody.linearVelocity.normalized * player.MaxSpeed;
		}
		else if (rigidbody.linearVelocity.magnitude < player.Data.MinSpeed)
		{
			rigidbody.linearVelocity = rigidbody.linearVelocity.normalized * player.Data.MinSpeed;
		}

		if (player.IsBrake)
		{
			// ÔøΩ«ÇÔøΩÔøΩÔøΩÔøΩCÔøΩxÔøΩÔøΩÔøΩgÔøΩÔøΩÔøΩÕëÔøΩÔøΩxÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ»ÇÔøΩ
			if (player.EventType != EventManager.EVENT_TYPE.TAIL_WIND)
			{
				player.Speed -= player.Data.BrakePower;
				if (player.Speed < 0.0f)
				{
					player.Speed = 0.0f;
				}
			}
		}

		float minAngle = -89.0f;
		float maxAngle = 89.0f;
		player.IsRotate = false;

		// ÔøΩAÔøΩ^ÔøΩbÔøΩ`ÔøΩÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÔøΩÔøΩÔøΩÕÉXÔøΩNÔøΩÔøΩÔøΩvÔøΩgÔøΩÃêÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ]ÔøΩÔøΩÔøΩÕÇÔøΩÔøΩ`ÔøΩFÔøΩbÔøΩN
		foreach (PlayerInput input in player.Inputs)
		{
			// ÔøΩeÔøΩÔøΩÔøΩÕéÔøΩÔøΩÃäÔøΩÔøΩxÔøΩÔøΩÔøΩÊìæ(ÔøΩAÔøΩCÔøΩeÔøΩÔøΩÔøΩ∆ÉCÔøΩxÔøΩÔøΩÔøΩgÔøΩ≈ÇÃäÔøΩÔøΩxÔøΩÃïœâÔøΩÔøΩÔøΩÔøΩ‹ÇÔøΩ)
			Vector3 sens = input.Yaw_Pitch_Role_Sensitivity +
				(player.Data.Item_rotation * player.GetItems[(int)Item.ITEM_EFFECT.ROTATION - 1]) + player.tornadoSens;

			// ÔøΩ«ÇÔøΩÔøΩÔøΩÔøΩxÔøΩÔøΩÔøΩÔøΩÔøΩXÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÔøΩ»ÇÔøΩ„è∏ÔøΩEÔøΩÔøΩÔøΩ~
			if (input.TotalGyro.y > 0.0f || input.TotalGyro.y < 0.0f)
			{
				// ÔøΩÔøΩ]ÔøΩ ÇÔøΩÔøΩZÔøΩo
				float angle = -input.TotalGyro.y * sens.x * Time.fixedDeltaTime;
				float beforeAngle = GetNorm(player.transform.eulerAngles.x );
				player.transform.Rotate(Vector3.right, angle, Space.Self);
				// -180ÔøΩÔøΩÔøΩÔøΩ180ÔøΩ…êÔøΩÔøΩKÔøΩÔøΩ
				float normAngle = GetNorm(player.transform.eulerAngles.x);
				// ÔøΩÔøΩÔøΩEÔøΩlÔøΩ`ÔøΩFÔøΩbÔøΩN(ÔøΩÔøΩÔøΩ≈Ç…åÔøΩÔøΩEÔøΩlÔøΩÃèÍçáÔøΩÕñÔøΩÔøΩÔøΩ)
				if ((normAngle < minAngle && beforeAngle > minAngle) || (normAngle > maxAngle && beforeAngle < maxAngle))
				{
					player.transform.Rotate(Vector3.right, -angle, Space.Self);
				}
			}

			bool beforeRotate = player.IsRotate;
			// ÔøΩ«ÇÔøΩÔøΩÔøΩÔøΩzÔøΩÔøΩÔøΩÔøΩÔøΩXÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÔøΩ»ÇÁç∂ÔøΩEÔøΩ⁄ìÔøΩ
			if (input.TotalGyro.z > 0.0f || input.TotalGyro.z < 0.0f)
			{
				player.IsRotate = true;
				float angleY = input.TotalGyro.z * sens.y * Time.fixedDeltaTime;
				player.transform.Rotate(Vector3.up, angleY, Space.World);
				// ÔøΩÔøΩ]ÔøΩ ÇÔøΩÔøΩZÔøΩo
				float angle = -input.TotalGyro.z * sens.z * Time.fixedDeltaTime;
				player.transform.Rotate(Vector3.forward, angle, Space.Self);
				// -180ÔøΩÔøΩÔøΩÔøΩ180ÔøΩ…êÔøΩÔøΩKÔøΩÔøΩ
				float normAngle = GetNorm(player.transform.eulerAngles.z);
				// ÔøΩÔøΩÔøΩEÔøΩlÔøΩ`ÔøΩFÔøΩbÔøΩN
				if (normAngle < -45.0f || normAngle > 45.0f)
				{
					player.transform.Rotate(Vector3.forward, -angle, Space.Self);
				}
			}

			//// ÔøΩ«ÇÔøΩÔøΩÔøΩÔøΩxÔøΩÔøΩÔøΩÔøΩÔøΩXÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÔøΩ»ÇÔøΩ„è∏ÔøΩEÔøΩÔøΩÔøΩ~
			//if (input.TotalGyro.x > 45.0f || input.TotalGyro.x < -45.0f || input.Gyro.x != 0.0f)
			//{
			//	// ÔøΩÔøΩÔøΩ[ÔøΩÔøΩÔøΩÔøΩ]ÔøΩêßå‰Ç∑ÔøΩÔøΩRÔøΩÔøΩÔøΩ[ÔøΩ`ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÈÇ©ÔøΩ`ÔøΩFÔøΩbÔøΩN
			//	if (rollControlCoroutine != null)
			//	{
			//		// ÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÔøΩÔøΩ»ÇÔøΩRÔøΩÔøΩÔøΩ[ÔøΩ`ÔøΩÔøΩÔøΩÔøΩÔøΩIÔøΩÔøΩ
			//		player.StopCoroutine(rollControlCoroutine);
			//		rollControlCoroutine = null;
			//	}
			//	// ÔøΩÔøΩ]ÔøΩ ÇÔøΩÔøΩZÔøΩo
			//	float angle = input.TotalGyro.x * (-1.0f) * sens.x * Time.fixedDeltaTime;
			//	float beforeAngle = Mathf.Repeat(player.transform.eulerAngles.x + 180.0f, 360.0f) - 180.0f;
			//	player.transform.Rotate(Vector3.right, angle, Space.Self);
			//	// -180ÔøΩÔøΩÔøΩÔøΩ180ÔøΩ…êÔøΩÔøΩKÔøΩÔøΩ
			//	float normAngle = Mathf.Repeat(player.transform.eulerAngles.x + 180.0f, 360.0f) - 180.0f;
			//	// ÔøΩÔøΩÔøΩEÔøΩlÔøΩ`ÔøΩFÔøΩbÔøΩN(ÔøΩÔøΩÔøΩ≈Ç…åÔøΩÔøΩEÔøΩlÔøΩÃèÍçáÔøΩÕñÔøΩÔøΩÔøΩ)
			//	if ((normAngle < minAngle && beforeAngle > minAngle) || (normAngle > maxAngle && beforeAngle < maxAngle))
			//	{
			//		player.transform.Rotate(Vector3.right, -angle, Space.Self);
			//	}
			//}

			//bool beforeRotate = player.IsRotate;
			//// ÔøΩ«ÇÔøΩÔøΩÔøΩÔøΩzÔøΩÔøΩÔøΩÔøΩÔøΩXÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÔøΩ»ÇÁç∂ÔøΩEÔøΩ⁄ìÔøΩ
			//if (input.TotalGyro.y > 45.0f || input.TotalGyro.y < -45.0f || input.Gyro.y != 0.0f)
			//{
			//	// ÔøΩÔøΩÔøΩ[ÔøΩÔøΩÔøΩÔøΩ]ÔøΩêßå‰Ç∑ÔøΩÔøΩRÔøΩÔøΩÔøΩ[ÔøΩ`ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÈÇ©ÔøΩ`ÔøΩFÔøΩbÔøΩN
			//	if (rollControlCoroutine != null)
			//	{
			//		// ÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÔøΩÔøΩ»ÇÔøΩRÔøΩÔøΩÔøΩ[ÔøΩ`ÔøΩÔøΩÔøΩÔøΩÔøΩIÔøΩÔøΩ
			//		player.StopCoroutine(rollControlCoroutine);
			//		rollControlCoroutine = null;
			//	}
			//	player.IsRotate = true;
			//	float angleY = input.TotalGyro.y * (-1.0f) * sens.y * Time.fixedDeltaTime;
			//	// ÔøΩÔøΩ]ÔøΩÔøΩÔøΩnÔøΩﬂÇÔøΩÔøΩtÔøΩÔøΩÔøΩ[ÔøΩÔøΩÔøΩ»ÇÔøΩÔøΩ]ÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÈéûÔøΩ‘ÇÃÉJÔøΩEÔøΩÔøΩÔøΩgÔøΩÔøΩÔøΩnÔøΩﬂÇÔøΩ
			//	if (!beforeRotate) 
			//	{
			//	}
			//	else
			//	{
			//		// ÔøΩÔøΩÔøΩ‘åoÔøΩﬂÇ…çÔøΩÔøΩÌÇπÔøΩƒÉJÔøΩÔøΩÔøΩÔøΩÔøΩÃÉIÔøΩtÔøΩZÔøΩbÔøΩgÔøΩÔøΩœÇÔøΩÔøΩÔøΩ
			//		Vector3 offset = vCameraCompoer.m_TrackedObjectOffset;
			//		if (angleY>=0.0f)
			//		{
			//			offset.x -= player.CameraData.TrackedOffset.x * (Time.fixedDeltaTime / player.CameraData.TrackedTime.x);
			//			offset.y += (player.CameraData.TrackedOffset.y - player.CameraData.StartTrackedOffset.y) * (Time.fixedDeltaTime / player.CameraData.TrackedTime.y);
			//		}
			//		else
			//		{
			//			offset.x += player.CameraData.TrackedOffset.x * (Time.fixedDeltaTime / player.CameraData.TrackedTime.x);
			//			offset.y += (player.CameraData.TrackedOffset.y - player.CameraData.StartTrackedOffset.y) * (Time.fixedDeltaTime / player.CameraData.TrackedTime.y);
			//		}
			//		if(offset.x<-player.CameraData.TrackedOffset.x)
			//		{
			//			offset.x = -player.CameraData.TrackedOffset.x;
			//		}
			//		if(offset.x > player.CameraData.TrackedOffset.x)
			//		{
			//			offset.x = player.CameraData.TrackedOffset.x;
			//		}
			//		if(offset.y > player.CameraData.TrackedOffset.y)
			//		{
			//			offset.y = player.CameraData.TrackedOffset.y;
			//		}
			//		vCameraCompoer.m_TrackedObjectOffset = offset;
			//	}
			//	player.transform.Rotate(Vector3.up, input.TotalGyro.y * sens.y * Time.fixedDeltaTime, Space.World);
			//	// ÔøΩÔøΩ]ÔøΩ ÇÔøΩÔøΩZÔøΩo
			//	float angle = input.TotalGyro.y * (-1.0f) * sens.z * Time.fixedDeltaTime;
			//	player.transform.Rotate(Vector3.forward, angle, Space.Self);
			//	// -180ÔøΩÔøΩÔøΩÔøΩ180ÔøΩ…êÔøΩÔøΩKÔøΩÔøΩ
			//	float normAngle = Mathf.Repeat(player.transform.eulerAngles.z + 180.0f, 360.0f) - 180.0f;
			//	// ÔøΩÔøΩÔøΩEÔøΩlÔøΩ`ÔøΩFÔøΩbÔøΩN
			//	if (normAngle < -45.0f || normAngle > 45.0f)
			//	{
			//		player.transform.Rotate(Vector3.forward, -angle, Space.Self);
			//	}
			//}
			//else
			//{
			//	player.IsRotate = false;
			//	if (vCameraCompoer.m_TrackedObjectOffset != player.CameraData.StartTrackedOffset)
			//	{
			//		Vector3 offset = vCameraCompoer.m_TrackedObjectOffset;
			//		if (vCameraCompoer.m_TrackedObjectOffset.x >= 0.0f)
			//		{
			//			offset.x -= player.CameraData.TrackedOffset.x * (Time.fixedDeltaTime / player.CameraData.ReturnTime.x);
			//			if (offset.x < player.CameraData.StartTrackedOffset.x)
			//			{
			//				offset.x = player.CameraData.StartTrackedOffset.x;
			//			}
			//		}
			//		else
			//		{
			//			offset.x += player.CameraData.TrackedOffset.x * (Time.fixedDeltaTime / player.CameraData.ReturnTime.x);
			//			if (offset.x > player.CameraData.StartTrackedOffset.x)
			//			{
			//				offset.x = player.CameraData.StartTrackedOffset.x;
			//			}
			//		}
			//		offset.y -= (player.CameraData.TrackedOffset.y - player.CameraData.StartTrackedOffset.y) * (Time.fixedDeltaTime / player.CameraData.ReturnTime.y);
			//		if (offset.y < player.CameraData.StartTrackedOffset.y)
			//		{
			//			offset.y = player.CameraData.StartTrackedOffset.y;
			//		}
			//		vCameraCompoer.m_TrackedObjectOffset = offset;
			//	}
			//}

			//„ÉÜ„Çπ„ÉàÁî®
			Debug.Log("TotalGyro" + input.TotalGyro.ToString());
        }
		if(!player.IsRotate)
		{
			ReturnRoll();
		}
		//if (!player.IsRotate && (player.transform.eulerAngles.z > 0.001f || player.transform.eulerAngles.z < -0.001f) && rollControlCoroutine == null)
		//{
		//	if (player.IsFollowWall)
		//	{
		//		return;
		//	}
		//	rollControlCoroutine = player.StartCoroutine(RollAttitudeControl());
		//}
	}


	/// <summary>
	/// ÔøΩÔøΩÔøΩ[ÔøΩÔøΩÔøΩÃépÔøΩÔøΩÔøΩÔøΩﬂÇÔøΩÔøΩRÔøΩÔøΩÔøΩ[ÔøΩ`ÔøΩÔøΩ
	/// </summary>
	/// <returns></returns>
	public IEnumerator RollAttitudeControl()
	{
		// ÔøΩÔøΩÔøΩ›ÇÃÉÔøΩÔøΩ[ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÃåXÔøΩÔøΩÔøΩ∆êÔøΩÔøΩÌéûÔøΩÃåXÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩAÔøΩpÔøΩÔøΩÔøΩíºÇÔøΩÔøΩNÔøΩHÔøΩ[ÔøΩ^ÔøΩjÔøΩIÔøΩÔøΩÔøΩÔøΩÔøΩÏê¨
		Quaternion fromQuat = player.transform.rotation;
		Quaternion toQuat = Quaternion.Euler(player.transform.eulerAngles.x, player.transform.eulerAngles.y, 0.0f);
		float nowTime = 0.0f;
		while (true)
		{
			nowTime += Time.fixedDeltaTime;
			Quaternion rot = Quaternion.Slerp(fromQuat, toQuat, nowTime / player.Data.RollControllTime);
			player.transform.rotation = rot;
			if (nowTime / player.Data.RollControllTime >= 1.0f)
			{
				rollControlCoroutine = null;
				yield break;
			}
			yield return new WaitForFixedUpdate();
		}
	}

	private void ReturnRoll()
	{
		// ÔøΩÔøΩÔøΩ›ÇÃÉÔøΩÔøΩ[ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÃåXÔøΩÔøΩÔøΩ∆êÔøΩÔøΩÌéûÔøΩÃåXÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩAÔøΩpÔøΩÔøΩÔøΩíºÇÔøΩÔøΩNÔøΩHÔøΩ[ÔøΩ^ÔøΩjÔøΩIÔøΩÔøΩÔøΩÔøΩÔøΩÏê¨
		Quaternion fromQuat = player.transform.rotation;
		Quaternion toQuat = Quaternion.Euler(player.transform.eulerAngles.x, player.transform.eulerAngles.y, 0.0f);
		Quaternion rot = Quaternion.Slerp(fromQuat, toQuat, player.Data.ReturnRollSpeed * Time.fixedDeltaTime);
		player.transform.rotation = rot;
	}

	private float GetNorm(float angle)
	{
		return Mathf.Repeat(angle + 180.0f, 360.0f) - 180.0f;
	}

	private Vector3 GetNorm(Vector3 vec)
	{
		return new Vector3(
			GetNorm(vec.x),
			GetNorm(vec.y),
			GetNorm(vec.z)
			);
	}

}
